<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Memento Daily Usability Form</title>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700">
		<link rel="stylesheet" href="setup/css/jquery-ui-1.9.2.custom.min.css">
		<link rel="stylesheet" href="setup/css/default.css">
		<style>
			.welcome-section {
				background: #f8f9fa;
				padding: 2rem;
				border-radius: 8px;
				margin-bottom: 2rem;
				text-align: center;
			}
			.participant-info {
				background: #e3f2fd;
				padding: 1.5rem;
				border-radius: 8px;
				margin-bottom: 2rem;
			}
			.data-export {
				background: #f3e5f5;
				padding: 1.5rem;
				border-radius: 8px;
				margin-top: 2rem;
			}
			.btn-group {
				display: flex;
				gap: 1rem;
				justify-content: center;
				margin-top: 1rem;
			}
			.btn {
				padding: 0.75rem 1.5rem;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 1rem;
				font-weight: 600;
				transition: all 0.3s ease;
				text-decoration: none;
				display: inline-block;
				min-width: 140px;
				text-align: center;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}
			.btn:active {
				transform: translateY(0);
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.btn-primary {
				background-color: #007bff;
				color: rgb(0, 0, 0);
			}
			.btn-primary:hover:not(:disabled) {
				background-color: #0056b3;
			}
			.btn-success {
				background-color: #28a745;
				color: white;
			}
			.btn-success:hover:not(:disabled) {
				background-color: #1e7e34;
			}
			.btn-secondary {
				background-color: #495057;
				color: rgb(0, 0, 0);
			}
			.btn-secondary:hover:not(:disabled) {
				background-color: #343a40;
				border-color: #343a40;
			}
			
			/* Rating Scale Styles */
			.rating-question {
				max-width: 800px;
				margin: 0 auto;
				padding: 2rem;
				text-align: center;
			}
			
			.question-progress {
				background: #e9ecef;
				border-radius: 10px;
				height: 8px;
				margin-bottom: 2rem;
			}
			
			.progress-bar {
				background: #007bff;
				height: 100%;
				border-radius: 10px;
				transition: width 0.3s ease;
			}
			
			.rating-scale {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin: 2rem 0;
				padding: 0 1rem;
			}
			
			.tick-container {
				display: flex;
				justify-content: space-between;
				align-items: center;
				width: 100%;
				margin: 1rem 0;
				position: relative;
			}
			
			.tick-line {
				position: absolute;
				top: 50%;
				left: 0;
				right: 0;
				height: 2px;
				background: #dee2e6;
				z-index: 1;
			}
			
			.tick {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				border: 3px solid #dee2e6;
				background: white;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
				font-size: 0.9rem;
				transition: all 0.2s ease;
				position: relative;
				z-index: 2;
			}
			
			.tick:hover {
				border-color: #007bff;
				background: #f8f9fa;
				transform: scale(1.1);
			}
			
			.tick.selected {
				border-color: #007bff;
				background: #007bff;
				color: white;
				transform: scale(1.2);
			}
			
			.scale-labels {
				display: flex;
				justify-content: space-between;
				margin-top: 1rem;
				font-size: 0.9rem;
				color: #6c757d;
			}
			
			.question-navigation {
				margin-top: 3rem;
				display: flex;
				gap: 1.5rem;
				justify-content: center;
				align-items: center;
				flex-wrap: wrap;
				padding: 1rem;
				background: rgba(248, 249, 250, 0.8);
				border-radius: 8px;
				border: 1px solid #dee2e6;
			}
			
			.current-rating {
				margin: 1rem 0;
				font-size: 1.2rem;
				font-weight: bold;
				color: #007bff;
				min-height: 30px;
			}
			
			@media (max-width: 768px) {
				.tick {
					width: 30px;
					height: 30px;
					font-size: 0.8rem;
				}
				
				.rating-question {
					padding: 1rem;
				}
				
				.tick-container {
					margin: 1.5rem 0;
				}
			}
			
			/* Loading spinner animation */
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
		</style>
	</head>
	<body>
		<article>
			<header>
				<h1>Memento Daily Usability Form</h1>
			</header>
			
			<!-- Welcome Section -->
			<section class="step_welcome">
				<div class="welcome-section">
					<p>Please answer the following questions based on your experience <b>today</b> with the Memento system.</p>
					<p><strong>Estimated time:</strong> 5-10 minutes</p>
					
					<div class="participant-info">
						<h3>Diary Information</h3>
						<label for="participant_id">Enter your name:</label><br>
						<input type="text" id="participant_id" placeholder="(First and Last name)" style="margin: 0.5rem; padding: 0.5rem; width: 300px;" required>
						<br>
						<label for="assessment_date">Date of Assessment (Month/Day/Year; <br><b>Please use the date you completed the task for</b><br>
							NOT just your current time):</label><br>
						<input type="date" id="assessment_date" style="margin: 0.5rem; padding: 0.5rem; width: 200px;" required>
					</div>
					
					<button class="btn btn-primary" onclick="startAssessment()">Start Assessment</button>
				</div>
			</section>

			<!-- Original sections with modifications -->
			<section class="step_0" style="display: none;">
				<h2>Assessment Progress</h2>
				<div id="container"></div>
				<div class="btn-group">
					<button class="btn btn-primary">Continue to Ratings</button>
				</div>
			</section>
			<section class="step_1" style="display: none;">
				<h2>Step 1: Participant Information Confirmed</h2>
				<div class="participant-summary" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
					<h3>Assessment Details</h3>
					<p><strong>Participant Name:</strong> <span id="display_participant_id"></span></p>
					<p><strong>Date of Assessment:</strong> <span id="display_task_description"></span></p>
					<p><strong>Current Time:</strong> <span id="display_timestamp"></span></p>
				</div>
				<p>Now you will rate your workload experience across 6 different dimensions. Please think about the task you just completed during the day, and rate each dimension honestly. Try to answer as <b>consistently</b> as possible across all dimensions.</p>
				<div class="btn-group">
					<button class="btn btn-secondary" onclick="goBackToWelcome()">← Back to Edit Info</button>
					<button class="btn btn-primary">Continue to Ratings →</button>
				</div>
			</section>
			<section class="step_2" style="display: none;">
				<div id="rating_container">
					<!-- Individual rating questions will be displayed here -->
				</div>
			</section>
			<section class="step_3" style="display: none;">
				<div id="pairwise_container">
					<!-- Pairwise comparisons will be generated here -->
				</div>
			</section>
			
			<section class="step_4" style="display: none;">
				<div style="text-align: center; padding: 2rem;">
					<h2 style="color: #28a745; margin-bottom: 1rem;">✓ Assessment Complete!</h2>
					<p style="font-size: 1.1rem; color: #6c757d; margin-bottom: 2rem;">
						Thank you for completing the Memento Daily Usability assessment.<br>
						Your responses have been automatically submitted to the researcher.
					</p>
					
					<div id="submission_status" style="margin: 2rem auto; padding: 1.5rem; border-radius: 8px; max-width: 500px; background: #e3f2fd; border: 1px solid #007bff;">
						<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
							<div id="loading_spinner" style="width: 20px; height: 20px; border: 2px solid #007bff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
							<span id="status_text" style="color: #007bff; font-weight: 600;">Submitting your responses...</span>
						</div>
					</div>
					
					<p style="color: #6c757d; font-size: 0.9rem;">
						You may now close this window.
					</p>
					
				</div>
			</section>
		</article>
		
		<!-- Enhanced JavaScript -->
		<script src="setup/js/jquery-1.8.3.min.js"></script>
		<script src="setup/js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="config.js"></script>
		<script src="setup/js/enhanced.js"></script>
		
		<script>
			// Global variables for the enhanced NASA-TLX
			let currentAssessment = {
				participantId: '',
				taskDescription: '',
				timestamp: '',
				ratings: {},
				comparisons: {},
				tlxScore: 0,
				completedAt: ''
			};
			
			// Start assessment function
			function startAssessment() {
				const participantName = document.getElementById('participant_id').value.trim();
				const assessmentDate = document.getElementById('assessment_date').value.trim();
				
				if (!participantName) {
					alert('Please enter your name before starting the assessment.');
					return;
				}
				
				if (!assessmentDate) {
					alert('Please select the date when you completed the task.');
					return;
				}
				
				currentAssessment.participantId = participantName;
				currentAssessment.taskDescription = `Memento system usage on ${assessmentDate}`;
				currentAssessment.assessmentDate = assessmentDate;
				currentAssessment.timestamp = new Date().toISOString();
				
				// Update display
				document.getElementById('display_participant_id').textContent = participantName;
				document.getElementById('display_task_description').textContent = currentAssessment.taskDescription;
				document.getElementById('display_timestamp').textContent = new Date().toLocaleString();
				
				// Show step 1
				document.querySelector('.step_welcome').style.display = 'none';
				document.querySelector('.step_1').style.display = 'block';
			}
			
			// Navigation functions
			function goBackToWelcome() {
				document.querySelector('.step_1').style.display = 'none';
				document.querySelector('.step_welcome').style.display = 'block';
			}
			
			function goToStep1() {
				document.querySelector('.step_2').style.display = 'none';
				document.querySelector('.step_1').style.display = 'block';
			}
			
			function goToStep2() {
				document.querySelector('.step_3').style.display = 'none';
				document.querySelector('.step_2').style.display = 'block';
			}
			
			// Data export functions
			function downloadResults() {
				const csvContent = generateCSV();
				const blob = new Blob([csvContent], { type: 'text/csv' });
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `NASA-TLX_${currentAssessment.participantId}_${new Date().toISOString().split('T')[0]}.csv`;
				a.click();
				window.URL.revokeObjectURL(url);
			}
			
			function copyResults() {
				const csvContent = generateCSV();
				navigator.clipboard.writeText(csvContent).then(() => {
					alert('Results copied to clipboard!');
				});
			}
			
			function generateCSV() {
				const headers = [
					'ParticipantName', 'AssessmentDate', 'TaskDescription', 'Timestamp', 'CompletedAt',
					'MentalDemand', 'PhysicalDemand', 'TemporalDemand', 'Performance', 'Effort', 'Frustration',
					'TLX_Score'
				];
				
				const values = [
					currentAssessment.participantId,
					currentAssessment.assessmentDate || '',
					currentAssessment.taskDescription,
					currentAssessment.timestamp,
					currentAssessment.completedAt,
					currentAssessment.ratings.mentalDemand || 0,
					currentAssessment.ratings.physicalDemand || 0,
					currentAssessment.ratings.temporalDemand || 0,
					currentAssessment.ratings.performance || 0,
					currentAssessment.ratings.effort || 0,
					currentAssessment.ratings.frustration || 0,
					currentAssessment.tlxScore || 0
				];
				
				return headers.join(',') + '\n' + values.map(v => `"${v}"`).join(',');
			}
			
			function startNewAssessment() {
				// Reset data
				currentAssessment = {
					participantId: '',
					taskDescription: '',
					assessmentDate: '',
					timestamp: '',
					ratings: {},
					comparisons: {},
					tlxScore: 0,
					completedAt: ''
				};
				
				// Reset form
				document.getElementById('participant_id').value = '';
				document.getElementById('assessment_date').value = '';
				
				// Reset sliders (will be handled by the original script)
				
				// Show welcome page
				document.querySelector('.step_4').style.display = 'none';
				document.querySelector('.step_welcome').style.display = 'block';
			}
			
			// Store data in localStorage for backup
			function saveToLocalStorage() {
				try {
					const allData = JSON.parse(localStorage.getItem('nasa_tlx_data') || '[]');
					allData.push(currentAssessment);
					localStorage.setItem('nasa_tlx_data', JSON.stringify(allData));
				} catch (e) {
					console.log('Could not save to localStorage:', e);
				}
			}
			
			// AUTOMATIC SUBMISSION OPTIONS
			// Configuration is now loaded from config.js
			
			// Main submission function
			async function submitToResearcher() {
				const submitBtn = document.getElementById('submit_btn');
				const statusDiv = document.getElementById('submission_status');
				
				// Disable button and show loading
				submitBtn.disabled = true;
				submitBtn.innerHTML = '📤 Submitting...';
				statusDiv.style.display = 'block';
				statusDiv.innerHTML = '<p style="color: #007bff;">⏳ Submitting your responses...</p>';
				
				try {
					let success = false;
					
					switch(RESEARCHER_CONFIG.submitMethod) {
						case 'email':
							success = await submitViaEmail();
							break;
						case 'googleform':
							success = await submitToGoogleForm();
							break;
						case 'webhook':
							success = await submitToWebhook();
							break;
						case 'airtable':
							success = await submitToAirtable();
							break;
						default:
							success = await submitViaEmail(); // Default fallback
					}
					
					if (success) {
						statusDiv.innerHTML = '<p style="color: #28a745;">✅ Successfully submitted! Thank you for participating.</p>';
						submitBtn.innerHTML = '✅ Submitted';
						submitBtn.style.backgroundColor = '#28a745';
					} else {
						throw new Error('Submission failed');
					}
					
				} catch (error) {
					console.error('Submission error:', error);
					statusDiv.innerHTML = `
						<p style="color: #dc3545;">❌ Automatic submission failed.</p>
						<p style="color: #6c757d;">Please use the "Download Backup" button and email the file to the researcher.</p>
					`;
					submitBtn.disabled = false;
					submitBtn.innerHTML = '🔄 Retry Submission';
				}
			}
			
			// Email submission with web-based options
			async function submitViaEmail() {
				const config = window.RESEARCHER_CONFIG;
				
				// Show email options to user
				const choice = await showEmailOptions();
				
				if (choice === 'gmail') {
					return submitViaGmail();
				} else if (choice === 'outlook') {
					return submitViaOutlook();
				} else if (choice === 'copy') {
					return copyEmailContent();
				} else {
					return false; // User cancelled
				}
			}
			
			// Show email service options
			function showEmailOptions() {
				return new Promise((resolve) => {
					const modal = document.createElement('div');
					modal.style.cssText = `
						position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
						background: rgba(0,0,0,0.7); z-index: 1000; display: flex; 
						align-items: center; justify-content: center;
					`;
					
					modal.innerHTML = `
						<div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; text-align: center;">
							<h3>Choose Email Method</h3>
							<p>How would you like to send your results?</p>
							<div style="display: flex; flex-direction: column; gap: 1rem; margin: 1.5rem 0;">
								<button class="btn btn-primary" onclick="selectEmail('gmail')" style="width: 100%;">
									📧 Open Gmail (Web)
								</button>
								<button class="btn btn-primary" onclick="selectEmail('outlook')" style="width: 100%;">
									📧 Open Outlook (Web)
								</button>
								<button class="btn btn-secondary" onclick="selectEmail('copy')" style="width: 100%;">
									📋 Copy Email Content
								</button>
							</div>
							<button class="btn btn-secondary" onclick="selectEmail('cancel')" style="margin-top: 1rem;">
								Cancel
							</button>
						</div>
					`;
					
					document.body.appendChild(modal);
					
					window.selectEmail = function(choice) {
						document.body.removeChild(modal);
						resolve(choice);
					};
				});
			}
			
			// Submit via Gmail web interface
			async function submitViaGmail() {
				const config = window.RESEARCHER_CONFIG;
				const csvData = generateCSV();
				
				const subject = encodeURIComponent(`${config.studyName} - Results from ${currentAssessment.participantId}`);
				const body = encodeURIComponent(`Dear Researcher,

Please find the Memento daily usability assessment results below:

=== PARTICIPANT INFORMATION ===
Name: ${currentAssessment.participantId}
Assessment Date: ${currentAssessment.assessmentDate}
Submission Time: ${new Date().toLocaleString()}

=== TASK DETAILS ===
Task: ${currentAssessment.taskDescription}

=== NASA-TLX RESULTS ===
Overall TLX Score: ${currentAssessment.tlxScore}

Individual Ratings (0-100 scale):
• Mental Demand: ${currentAssessment.ratings.mentalDemand || 0}
• Physical Demand: ${currentAssessment.ratings.physicalDemand || 0}
• Temporal Demand: ${currentAssessment.ratings.temporalDemand || 0}
• Performance: ${currentAssessment.ratings.performance || 0}
• Effort: ${currentAssessment.ratings.effort || 0}
• Frustration: ${currentAssessment.ratings.frustration || 0}

=== RAW DATA (CSV FORMAT) ===
${csvData}

---
This response was automatically generated by the ${config.studyName}.

Best regards,
${currentAssessment.participantId}`);
				
				const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(config.email)}&su=${subject}&body=${body}`;
				window.open(gmailUrl, '_blank');
				
				return true;
			}
			
			// Submit via Outlook web interface
			async function submitViaOutlook() {
				const config = window.RESEARCHER_CONFIG;
				const csvData = generateCSV();
				
				const subject = encodeURIComponent(`${config.studyName} - Results from ${currentAssessment.participantId}`);
				const body = encodeURIComponent(`Dear Researcher,

Please find the Memento daily usability assessment results below:

=== PARTICIPANT INFORMATION ===
Name: ${currentAssessment.participantId}
Assessment Date: ${currentAssessment.assessmentDate}
Submission Time: ${new Date().toLocaleString()}

=== TASK DETAILS ===
Task: ${currentAssessment.taskDescription}

=== NASA-TLX RESULTS ===
Overall TLX Score: ${currentAssessment.tlxScore}

Individual Ratings (0-100 scale):
• Mental Demand: ${currentAssessment.ratings.mentalDemand || 0}
• Physical Demand: ${currentAssessment.ratings.physicalDemand || 0}
• Temporal Demand: ${currentAssessment.ratings.temporalDemand || 0}
• Performance: ${currentAssessment.ratings.performance || 0}
• Effort: ${currentAssessment.ratings.effort || 0}
• Frustration: ${currentAssessment.ratings.frustration || 0}

=== RAW DATA (CSV FORMAT) ===
${csvData}

---
This response was automatically generated by the ${config.studyName}.

Best regards,
${currentAssessment.participantId}`);
				
				const outlookUrl = `https://outlook.live.com/mail/0/deeplink/compose?to=${encodeURIComponent(config.email)}&subject=${subject}&body=${body}`;
				window.open(outlookUrl, '_blank');
				
				return true;
			}
			
			// Copy email content to clipboard
			async function copyEmailContent() {
				const formattedResults = generateFormattedResults();
				
				try {
					await navigator.clipboard.writeText(formattedResults);
					alert('Email content copied to clipboard! Now paste it into your email app.');
					return true;
				} catch (error) {
					alert('Copy failed. Please try a different method.');
					return false;
				}
			}
			
			// Option 2: Google Forms submission
			async function submitToGoogleForm() {
				if (!RESEARCHER_CONFIG.googleFormURL) {
					throw new Error('Google Form URL not configured');
				}
				
				// You'll need to map your form fields to the data
				const formData = new FormData();
				formData.append('entry.123456789', currentAssessment.participantId); // Replace with your form entry IDs
				formData.append('entry.987654321', currentAssessment.taskDescription);
				formData.append('entry.111111111', currentAssessment.tlxScore);
				// Add more fields as needed
				
				const response = await fetch(RESEARCHER_CONFIG.googleFormURL, {
					method: 'POST',
					body: formData,
					mode: 'no-cors' // Required for Google Forms
				});
				
				return true; // Google Forms doesn't return proper response with no-cors
			}
			
			// Option 3: Webhook submission (for custom servers)
			async function submitToWebhook() {
				if (!RESEARCHER_CONFIG.webhookURL) {
					throw new Error('Webhook URL not configured');
				}
				
				const response = await fetch(RESEARCHER_CONFIG.webhookURL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(currentAssessment)
				});
				
				return response.ok;
			}
			
			// Option 4: Airtable submission (popular for research)
			async function submitToAirtable() {
				// You'll need to configure Airtable API details
				const AIRTABLE_CONFIG = {
					baseId: 'your_base_id',
					tableId: 'your_table_id', 
					apiKey: 'your_api_key'
				};
				
				const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableId}`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						records: [{
							fields: {
								'ParticipantID': currentAssessment.participantId,
								'TaskDescription': currentAssessment.taskDescription,
								'TLX_Score': currentAssessment.tlxScore,
								'MentalDemand': currentAssessment.ratings.mentalDemand,
								'PhysicalDemand': currentAssessment.ratings.physicalDemand,
								'TemporalDemand': currentAssessment.ratings.temporalDemand,
								'Performance': currentAssessment.ratings.performance,
								'Effort': currentAssessment.ratings.effort,
								'Frustration': currentAssessment.ratings.frustration,
								'Timestamp': currentAssessment.timestamp,
								'CompletedAt': currentAssessment.completedAt
							}
						}]
					})
				});
				
				return response.ok;
			}
		</script>
	</body>
</html>